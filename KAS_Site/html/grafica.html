<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="/css/style.css">
	<link rel="icon" type="image/png" href="Kas_logo_icon.png">
	<script src="http://code.jquery.com/jquery-3.6.0.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
	<title>grafica_kas</title>
</head>

<body>
	<section>
		<ul>
			<li id="statsdeStats"><a href="estatistica.html">Mapas</a></li>
			<li id="statsDeStocks"><a href="stocks.html">Stocks</a></li>
			<li id="statsdeGraphs"><a href="grafica.html">Gráficos</a></li>
			<li class="dropdown">
				<a id="login" href="perfil.html" class="dropbtn">Perfil</a>
				<div class="dropdown-content">
					<a id="exit">Logout</a>
				</div>
			</li>
		</ul>
	</section>
	<center>
		<h1>Gráficos</h1>
	</center>
	<br>


	<button id="export">Exportar</button>

	<br>
	<br>
	<center>
		<div class="graficos">
			<canvas id="myChart" style="width:100%;max-width:600px"></canvas>
		</div>
		<br>
		<div class="graficos">
			<canvas id="myChart2" style="width:100%;max-width:600px"></canvas>
		</div>
		<br>
		<div class="graficos">
			<canvas id="myChart3" style="width:100%;max-width:600px"></canvas>
		</div>
	</center>

</body>
<script src="/javascript/scripts_allpages.js"></script>
<script src="/javascript/cookies.js"></script>
<script>
	$(document).ready(function () {

		$.ajax({
			url: 'http://localhost:3000/sales/getProductSales',
			type: 'GET',
			dataType: 'json',
			success: function (response) {
				const data = response;

				// Extrair os dados necessários para os gráficos
				const productNames = data.map(item => item.product_name);
				const totalSales = data.map(item => item.total_sales);

				// Definir paleta de cores
				const colors = generateColors(productNames.length);

				// Plotar gráfico de barras para as vendas de produtos
				plotBarChart(productNames, totalSales, colors);
				plotPieChart(productNames, totalSales, colors);
				plotHorizontalBarChart(productNames, totalSales, colors);
			},
			error: function (xhr, status, error) {
				console.error('Erro ao obter dados dos produtos:', error);
			}
		});

		// Função para gerar cores aleatórias
		function generateColors(numColors) {
			const colors = [];
			for (let i = 0; i < numColors; i++) {
				const color = '#' + Math.floor(Math.random() * 16777215).toString(16);
				colors.push(color);
			}
			return colors;
		}

		// Função para plotar gráfico de barras
		function plotBarChart(labels, data, colors) {
			var ctx = document.getElementById('myChart').getContext('2d');
			var myChart = new Chart(ctx, {
				type: 'bar',
				data: {
					labels: labels,
					datasets: [{
						label: 'Total de Vendas do Produto',
						data: data,
						backgroundColor: colors,
						borderColor: 'rgba(54, 162, 235, 1)',
						borderWidth: 1
					}]
				},
				options: {
					scales: {
						y: {
							beginAtZero: true
						}
					}
				}
			});
		}

		// Função para plotar gráfico de pizza
		function plotPieChart(labels, data, colors) {
			var ctx = document.getElementById('myChart2').getContext('2d');
			var myChart = new Chart(ctx, {
				type: 'pie',
				data: {
					labels: labels,
					datasets: [{
						label: 'Total de Vendas do Produto',
						data: data,
						backgroundColor: colors,
						borderColor: 'rgba(255, 99, 132, 1)',
						borderWidth: 1
					}]
				},
				options: {
					scales: {
						y: {
							beginAtZero: true
						}
					}
				}
			});
		}

		// Função para plotar gráfico de barra horizontal
		function plotHorizontalBarChart(labels, data, colors) {
			var ctx = document.getElementById('myChart3').getContext('2d');
			var myChart = new Chart(ctx, {
				type: 'horizontalBar',
				data: {
					labels: labels,
					datasets: [{
						label: 'Total de Vendas do Produto',
						data: data,
						backgroundColor: colors,
						borderColor: 'rgba(75, 192, 192, 1)',
						borderWidth: 1
					}]
				},
				options: {
					scales: {
						x: {
							beginAtZero: true
						}
					}
				}
			});
		}

		$('#export').click(function () {
            $.ajax({
                url: 'http://localhost:3000/sales/getProductSales',
                type: 'GET',
                dataType: 'json',
                success: function (response) {
                    const data = response;

                    // Extrair os dados necessários para a exportação
                    const worksheetData = data.map(item => [item.product_name, item.total_sales]);
                    worksheetData.unshift(['Produto', 'Vendas']); // Adicionar cabeçalho

                    // Criar a planilha
                    var worksheet = XLSX.utils.aoa_to_sheet(worksheetData);

                    // Criar um novo livro de Excel e adicionar a planilha
                    var workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, 'Vendas');

                    // Salvar o arquivo Excel
                    XLSX.writeFile(workbook, 'vendas.xlsx');
                },
                error: function (xhr, status, error) {
                    console.error('Erro ao obter dados dos produtos:', error);
                }
            });
        });

	});
</script>

</html>
